---
title: "R workshop"
subtitle: "Data manupulation & Rmarkdown"
author: "Bolin Wu"
institute: "NEAR, Aging Research Center"
date: "2023/01/26 (updated: `r Sys.Date()`)"
output:
  xaringan::moon_reader:
    css: [default, ki, ki-fonts]
    lib_dir: libs
    nature:
      # highlightStyle: github
      highlightLines: true
      contIncrementalSlides: false
    # chakra: libs/remark-latest.min.js
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(
  htmltools.dir.version = FALSE,
  htmltools.preserve.raw = FALSE
)
```

---

## About me 

.pull-left[

![](https://ki-su-arc.se/wp-content/uploads/2021/10/Bolin-Wu_foto-Maria-Yohuang-200x300.jpg)
] 

.pull-left[

- MSc in Statistics, Uppsala University.
- Statistician at [NEAR](https://www.near-aging.se/), KI.
- Interests: 
  - R package dev
  - Statistics
  - Data manipulation
  - guitar
]



---
## `workshopr` package

### Install
```{r, eval=FALSE}
install.packages("remotes")
remotes::install_github("Bolin-Wu/workshopr",
  subdir = "rpackage",
  force = TRUE
)
```


### Load
```{r, message=FALSE}
library(workshopr)
library(tidyverse)
```

---
class: center, middle

# Data manupulation

### tidyverse, assign

---
## Introduction

This session is to share useful data manipulation skills at daily epidemiology work. My main goal is to follow the "don't repeat yourself" (DRY) principle. 

It can make our code more readable and reduce our chance of making mistakes.
---

## Content

- %>% syntax
- transform data shape 
- get the label from DTA and SPSS in R
- filter variables based on name pattern
- check missing values
- bin variables by percentiles
- assign function

???

For example, change a variable name in the code, but forget to change other places
---

## Tidyverse


Many times we just `library(tidyverse)`, but [Tidyverse](https://www.tidyverse.org/packages/) is a huge umbrella consists of several powerful visualization and data manipulation package. For example:

- [magrittr](https://magrittr.tidyverse.org/): pipeline operator `%>%`.
- [ggplot2](https://ggplot2.tidyverse.org/): `ggplot()`.
- [dplyr](https://dplyr.tidyverse.org/): `select(), filter(), mutate()`


---

Beautiful syntax with pipeline, just like playing LEGO.

![](pic/legos.jpg)

---
## Transform data shape
Transform data shape for many people, including me, sounds troublesome. In R, its relevant functions are evolving overtime as well.

--

In the beginning (2019), I used [spread](https://tidyr.tidyverse.org/reference/spread.html) and [gather](https://tidyr.tidyverse.org/reference/gather.html).  Every time I use `spread` and `gather`, it takes me a while to figure out how to fill in 'key' and 'value'. But as you can see from their documentation, their 'lifecycle' is 'superseded'.

---

Now I only use `pivot_longer` and `pivot_wider` for transforming data. You can find their comprehensive documentation [here](https://tidyr.tidyverse.org/articles/pivot.html). They come with better documentation, more powerful application, and better integration with tidyverse syntax.

# Example

Let's assumme we received a wide format data:

```{r check data}
head(fake_snack_df)
```

The column names are:

```{r check column names}
sort(colnames(fake_snack_df))
```

Now, assume for some reason, e.g. merge it with other data set, we want to transform it in a long format. There are two variables should be formated: 'Date' and 'dementia'. For beginners, I would recommend to start small. 

* Select the interested columns

```{r start small}
fake_snack_df %>%
  select(contains("Date"))
```

* Read documentation, try to fill in the arguments. The 3 basic arguments are:
  * `cols` tells R what variables to pivot.
  * `names_to` defines a new name for columns in `cols`. 
  * `values_to` gives a new name for values under the columns in `cols`.
  
Let's give a first try:

  
```{r pivot date}
# check pivot_longer() documentation in R: ?pivot_longer()
fake_snack_df %>%
  select(Lopnr, contains("Date")) %>%
  pivot_longer(
    cols = contains("Date"),
    names_to = "wave", names_prefix = "Date",
    values_to = "date"
  )
```

The result above looks good, but 'wave' looks a bit strange. I will leave the task to audience to fix this column.


* Do the same with 'dementia' columns

```{r}
fake_snack_df %>%
  select(Lopnr, contains("dementia")) %>%
  pivot_longer(
    cols = contains("dementia"),
    names_to = "wave", names_prefix = "dementia",
    values_to = "dementia"
  )
```




## Task 
1. Change the arguments in the pivot_longer function to get proper wave column. Result example:
```{r, echo=FALSE, purl=FALSE}
# answer
fake_snack_df %>%
  select(Lopnr, contains("Date")) %>%
  pivot_longer(
    cols = contains("Date"),
    names_to = "wave", names_prefix = "Date_wave",
    values_to = "date"
  )
```
2. Merge the two long pivot dataset together.
3. Optional: Pivot the original 'fake_snack_df' by using only one `pivot_longer` function. Put wave and date after 'Lopnr' column. *Hint: check the `names_to` argument and `relocate()` function*. Result example:

```{r, echo=FALSE, purl=FALSE}
# answer
fake_snack_df %>%
  pivot_longer(contains("wave"),
    names_to = c(".value", "wave"),
    names_sep = "_",
    values_drop_na = TRUE
  ) %>%
  relocate(wave:Date, .after = Lopnr)
```





---
class: center, middle

# R markdown

## Basics and daily work uses

---



---

```{r, include=FALSE, eval=TRUE}
# remotes::install_github('rstudio/pagedown', force = TRUE)
# pagedown::chrome_print("index.html")
# renderthis::to_pdf("index.html")
# pagedown::chrome_print("index.Rmd")
```


```{r, include=FALSE, eval=FALSE, purl=FALSE}
# pkg_path <- "/Users/bolin/Documents/KI_local/work_tasks/presentation/workshopr/rpackage/inst/templates/rscript"

# knitr::purl("rmd/data_manupulation.Rmd",
#   output = here("R", "tidyverse_2023.R"),
#   documentation = 1
# )
# 
# knitr::purl("rmd/data_manupulation.Rmd",
#   output = paste0(pkg_path, "/tidyverse_2023.R"),
#   documentation = 1
# )
```

