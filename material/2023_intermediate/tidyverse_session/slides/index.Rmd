---
title: "R workshop"
subtitle: "Data manupulation & Rmarkdown"
author: "Bolin Wu"
institute: "NEAR, Aging Research Center"
date: "2023/01/26 (updated: `r Sys.Date()`)"
output:
  xaringan::moon_reader:
    css: [default, ki, ki-fonts]
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      contIncrementalSlides: false
    # chakra: libs/remark-latest.min.js
---




```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, comment = NA)
options(
  htmltools.dir.version = FALSE,
  htmltools.preserve.raw = FALSE
)
```

---

## About me 

.pull-left[

![](pic/Bolin_pic.png)
] 

.pull-left[

- Statistician at [NEAR](https://www.near-aging.se/), KI.
- MSc in Statistics, Uppsala University.
- Interests: 
  - R package dev
  - Statistics
  - Data manipulation
  - guitar
]



---
## `workshopr` package

### Install
```{r, eval=FALSE}
install.packages("remotes")
remotes::install_github("Bolin-Wu/workshopr",
  subdir = "rpackage",
  force = TRUE
)
```


### Load
```{r, message=FALSE}
library(workshopr)
library(tidyverse)
```

---
class: center, middle

# Data manupulation

### tidyverse, assign

---
## Introduction

This session is to share useful data manipulation skills at daily epidemiology work. My main goal is to follow the "don't repeat yourself" (DRY) principle. 

It can make our code more readable and reduce our chance of making mistakes.

*Note: Data frames may seem to be unfit in the slides. I do not user any html widges since the code will be pulled out for tutorial purpose. Attendants can run the code on their on machine instead to get better view.*
---

## Content

Based on real work scenario:

- %>% syntax
- join data frames (*join function*)
- transform data shape (*pivot_longer*)
- filter variables based on name pattern (*select*)
- get the label from DTA and SPSS in R (*filter*)
- check missing values 
- bin variables by percentiles
- assign function

???

For example, change a variable name in the code, but forget to change other places
---

# Tidyverse


Many times we just `library(tidyverse)`. Actually [Tidyverse](https://www.tidyverse.org/packages/) is a huge umbrella consists of several powerful visualization and data manipulation package. For example:

- [magrittr](https://magrittr.tidyverse.org/): pipeline operator `%>%`.
- [ggplot2](https://ggplot2.tidyverse.org/): `ggplot()`.
- [dplyr](https://dplyr.tidyverse.org/): `select(), filter(), mutate()`

### Notes

- Advantage: All at once.
- Disadvantage: 
  - Slower to load the whole package. 
  - Potential conflicts of function names with other packages. Example [here](https://tidyverse.tidyverse.org/reference/tidyverse_conflicts.html).

???

Just heads up, in case in the future you find one function does not work as it expected. Then you know it could because of the conflicts of tidyverse.

---

## Pipeline operator `%>%`
Beautiful syntax with pipeline, just like playing LEGO.

![](pic/legos.jpg)

---

### Example

```{r}
fake_snack_df %>%
  select(Lopnr, Date_wave1)
```

---

In addition, filter on the date column

```{r continue example}
fake_snack_df %>%
  select(Lopnr, Date_wave1) %>%
  filter(Date_wave1 > "1800-01-01") %>%
  slice(1:5)
```

--

You can further stacking group, filter, mutate, etc., with the pipeline operator.

???
This syntax makes data manupulation convenient and easy to read.

---
## Join data frames


* With `.*_join()` function: There are 4 common types of joins.


![](pic/join_tabel.png)

---

Take `left_join()` as an example: 

```{r}
# From  `dplyr` documentation:
df1 <- tibble(x = 1:3)
df2 <- tibble(
  x = c(1, 1, 2),
  y = c("first", "second", "third")
)
df1 %>% left_join(df2)
```

???
Please note, in this example, df1 is on the left side.



---
## Transform data shape
Transform data shape is frequently used to clean data. However, for many people, including me, it sounds troublesome. In R, its relevant functions are evolving overtime as well.

--

In the beginning (2019), I used [spread()](https://tidyr.tidyverse.org/reference/spread.html) and [gather()](https://tidyr.tidyverse.org/reference/gather.html).  Every time I use `spread()` and `gather()`, it takes me a while to figure out how to fill in 'key' and 'value'. But as you can see from their documentation, their 'lifecycle' is 'superseded'.

---
## Transform data shape

Now I only use `pivot_longer()` and `pivot_wider()` for transforming data. You can find their comprehensive documentation [here](https://tidyr.tidyverse.org/articles/pivot.html). 

--

They come with better documentation, more powerful application, and better integration with tidyverse syntax.

---

### Example

Let's assume we received a wide format data:

```{r check data}
head(fake_snack_df, n = 5)
```

???
Please run the code in your R studio to get a better view.
---

### Example

The column names are:

```{r check column names}
sort(colnames(fake_snack_df))
```

--

Now, assume for some reason, e.g. merge it with other data set, we want to transform it in a long format. 

--

There are two variables with prefix should be formatted: 'Date' and 'dementia'. For beginners, I would recommend to start small. 

---
### Example
- Select the interested columns

```{r start small}
fake_snack_df %>%
  select(contains("Date")) %>%
  slice(1:5)
```

---
### Example

Read documentation, try to fill in the arguments. 
```{r, eval=FALSE}
?tidyr::pivot_longer()
```

--

- The 3 basic arguments are:
  * `cols()`: tells R what variables to pivot.
  * `names_to()`:  a new name for columns in `cols()`. 
  * `values_to()`: a new name for **values** under the columns in `cols()`.

---

### Example
Let's give a first try:

  
```{r pivot date}
fake_snack_df %>%
  select(Lopnr, contains("Date")) %>%
  pivot_longer(
    cols = contains("Date"),
    names_to = "wave", values_to = "date",
    names_prefix = "Date"
  )
```


---

### Example

The result above looks good, but 'wave' looks a bit strange. I will leave the task to audience to fix this column.


--
* Do the same with 'dementia' columns

--

```{r}
fake_snack_df %>%
  select(Lopnr, contains("dementia")) %>%
  pivot_longer(
    cols = contains("dementia"),
    names_to = "wave", names_prefix = "dementia",
    values_to = "dementia"
  )
```

???
Pay attention to what arguments are changed, what are not changed.

---

### Data transform exercise (5 - 10 min)

- Read documentation. Change the arguments in the `pivot_longer()` function to get proper wave column. 

*Example result (first 5 rows):*

```{r, echo=FALSE, purl=FALSE}
# answer
fake_snack_df %>%
  select(Lopnr, contains("Date")) %>%
  pivot_longer(
    cols = contains("Date"),
    names_to = "wave", names_prefix = "Date_wave",
    values_to = "date"
  ) %>%
  mutate(wave = as.factor(wave)) %>%
  slice_head(n = 5)
```

--

- Merge the two long pivot data sets together. 


???
Consider: is it enough to only join on one column? Why or why not?

---

## Select variables by name pattern

Some times you get data with specific variables. E.g.

- Each wave has its own specific prefix.
- Questionnaire/in person test has its own prefix.
- ...

--

In this case, the `select()` function can help you. Some useful **selection helpers** are

- `starts_with()`
- `contains()`
- `matches()`
- ...

More details please see documentation:
```{r, eval=FALSE}
?select()
```

???
Explain them. 90% of the time I just use these four.

---

### starts_with

```{r, eval=FALSE}
fake_snack_df %>%
  select(starts_with("Date"))
```

### contains

```{r, eval=FALSE}
fake_snack_df %>%
  select(contains("Date") & contains("wave"))
```

--

- Imagine if only using `contains('Date')` without '&' operator. What result would look like? Then try it.

---

### match

- `match()` is more advanced since it uses [regular expression (regex)](https://en.wikipedia.org/wiki/Regular_expression). 

--

- There are many regex cheatsheets online. For exmaple [this](https://www.rexegg.com/regex-quickstart.html).

--

- One useful website to test regex is [here](https://regex101.com).

```{r, eval=FALSE}
fake_snack_df %>%
  select(matches("Date_wave\\d"))
```


???

With match basically you can filter any pattern of variable names you want.

I can show to test it in the online test website.


---

## Get labels from datasets

When we get SPSS or STATA data sets, usually they come with labels. E.g. in SPSS, one can check them in the "Variable View" tab. 

--

In R, one can use `view()` function. In the example data, we have:

```{r, eval=FALSE}
view(fake_snack_df)
```


![](pic/df_label.png)

--

A natural thing to consider is to extract label information in the data frame form.


---

If you run `str()` function, the labels are in the "label" attribute. There are multiple ways to extract the labels.

```{r, eval=FALSE}
str(fake_snack_df)
```

--

The one I use is the [sjlabelled](https://strengejacke.github.io/sjlabelled/articles/labelleddata.html) R package.

```{r}
label_char <- sjlabelled::get_label(fake_snack_df)
label_char
```

```{r, purl=FALSE, echo=FALSE}
knitr::kable(label_char)
```

---

The result looks terrible, so we have to fix it by transforming it to be tibble:

```{r}
label_df <- tibble::rownames_to_column(as.data.frame(label_char), "variable")
label_df <- tibble::as_tibble(label_df)
label_df
```

---

The result looks much better! Now we can do lots of things with pipeline.

- filter the label contains 'dementia'

```{r}
label_df %>%
  filter(grepl("dementia", label_char))
```

---

- filter the variable contains 'wave'

```{r}
label_df %>%
  filter(grepl("wave", variable))
```


???
This can be useful when you got hundreds of variables in a file.

There's one project has 200+ variables, I need to select the variables related to smoking.

---

## Missing values

- Generate missing values in date columns

```{r}

miss_date_df <- missMethods::delete_MCAR(fake_snack_df,
  p = seq(0.1, 0.8, length.out = length(fake_snack_df)))
```

--


- A quick question: what if you want to select the numeric columns?


---
```{r}
head(miss_date_df)
```



---

### Count the NA

- If count the NA of one column. It could something like:

```{r}
sum(is.na(miss_date_df$Date_wave1))
```
--

- What if multiple columns?

---

### Count NA in multiple columns

```{r Count NA in multiple columns}
miss_date_df %>%
  summarise(across(
    where(lubridate::is.Date),
    ~ sum(is.na(.))
  ))
```


--

- One can also use `colSums(is.na(miss_date_df))`. 

---

## Missing value exercise (5 min)

- Read the documentation of `across()` function.
- Count the NA of all numeric columns.




---
class: center, middle

# R markdown

## Basics and daily work uses

---



---

### Exercise

- Optional: Pivot the original 'fake_snack_df' by using only one `pivot_longer()` function. Put wave and date after 'Lopnr' column. *Hint: check the `names_to` argument and `relocate()` function*. Result example:

```{r, echo=FALSE, purl=FALSE}
# answer
fake_snack_df %>%
  pivot_longer(contains("wave"),
    names_to = c(".value", "wave"),
    names_sep = "_",
    values_drop_na = TRUE
  ) %>%
  relocate(wave:Date, .after = Lopnr)
```


---

## Wrap up

* This whole slide is written in Rmarkdown with some pretty cool functions. Check documentation [here](https://github.com/yihui/xaringan).

```{r, include=FALSE, eval=TRUE}
# remotes::install_github('rstudio/pagedown', force = TRUE)
# pagedown::chrome_print("index.html")
# renderthis::to_pdf("index.html")
# pagedown::chrome_print("index.Rmd")
```


```{r, include=FALSE, eval=FALSE, purl=FALSE}
# pkg_path <- "/Users/bolin/Documents/KI_local/work_tasks/presentation/workshopr/rpackage/inst/templates/rscript"

# knitr::purl("rmd/data_manupulation.Rmd",
#   output = here("R", "tidyverse_2023.R"),
#   documentation = 1
# )
#
# knitr::purl("rmd/data_manupulation.Rmd",
#   output = paste0(pkg_path, "/tidyverse_2023.R"),
#   documentation = 1
# )
```
