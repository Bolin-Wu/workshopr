<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>R workshop</title>
    <meta charset="utf-8" />
    <meta name="author" content="Bolin Wu" />
    <script src="libs/header-attrs/header-attrs.js"></script>
    <link href="libs/remark-css/default.css" rel="stylesheet" />
    <link href="libs/remark-css/ki.css" rel="stylesheet" />
    <link href="libs/remark-css/ki-fonts.css" rel="stylesheet" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

.title[
# R workshop
]
.subtitle[
## Data manupulation &amp; Rmarkdown
]
.author[
### Bolin Wu
]
.institute[
### NEAR, Aging Research Center
]
.date[
### 2023/01/26 (updated: 2023-01-26)
]

---






---
## `workshopr` package

### Install


```r
install.packages("remotes")
remotes::install_github("Bolin-Wu/workshopr",
  subdir = "rpackage",
  force = TRUE
)
```

### Load

```r
library(workshopr)
library(tidyverse)
```

---
class: center, middle

# Data manupulation

### tidyverse, assign

---
## Introduction

This session is to share useful data manipulation skills at daily epidemiology work. My main goal is to follow the "don't repeat yourself" (DRY) principle. 

It can make our code more readable and reduce our chance of making mistakes.
---

## Content

- %&gt;% syntax
- transform data shape 
- get the label from DTA and SPSS in R
- filter variables based on name pattern
- check missing values
- bin variables by percentiles
- assign function

???

For example, change a variable name in the code, but forget to change other places
---

## Tidyverse

[Tidyverse](https://www.tidyverse.org/packages/) is a huge umbrella which includes several useful visualization and data manipulation package.


We have to 

Beautiful syntax with pipeline, just like playing LEGO.

![](pic/legos.jpg)

---
## Transform data shape
Transform data shape for many people, including me, sounds troublesome. In R, its relevant functions are evolving overtime as well.

--

In the beginning (2019), I used [spread](https://tidyr.tidyverse.org/reference/spread.html) and [gather](https://tidyr.tidyverse.org/reference/gather.html).  Every time I use `spread` and `gather`, it takes me a while to figure out how to fill in 'key' and 'value'. But as you can see from their documentation, their 'lifecycle' is 'superseded'.

---

Now I only use `pivot_longer` and `pivot_wider` for transforming data. You can find their comprehensive documentation [here](https://tidyr.tidyverse.org/articles/pivot.html). They come with better documentation, more powerful application, and better integration with tidyverse syntax.

# Example

Let's assumme we received a wide format data:


```r
head(fake_snack_df)
```

```
## # A tibble: 6 x 15
##   Lopnr    sex Date_wave1 education Date_wave2 Date_wave3 Date_wave4
##   &lt;int&gt;  &lt;dbl&gt; &lt;date&gt;         &lt;dbl&gt; &lt;date&gt;     &lt;date&gt;     &lt;date&gt;    
## 1  1284 -1.62  1848-01-16   -1.00   1703-06-26 1807-08-10 1764-12-13
## 2  2013  0.384 1788-07-16    0.883  1785-09-24 1811-08-26 1812-05-24
## 3  1618 -0.363 1833-09-17    0.0753 1792-10-19 1781-01-06 1746-09-20
## 4  3190  0.682 1803-04-08    0.0943 1829-04-27 1744-02-04 1846-08-24
## 5  1103  0.521 1705-06-10    1.37   1734-12-24 1746-03-13 1829-11-30
## 6  2193  0.308 1733-11-07    0.771  1794-06-13 1738-06-02 1846-12-28
## # ... with 8 more variables: Date_wave5 &lt;date&gt;, Date_wave6 &lt;date&gt;,
## #   dementia_wave1 &lt;dbl&gt;, dementia_wave2 &lt;dbl&gt;, dementia_wave3 &lt;dbl&gt;,
## #   dementia_wave4 &lt;dbl&gt;, dementia_wave5 &lt;dbl&gt;, dementia_wave6 &lt;dbl&gt;
```

The column names are:


```r
sort(colnames(fake_snack_df))
```

```
##  [1] "Date_wave1"     "Date_wave2"     "Date_wave3"     "Date_wave4"    
##  [5] "Date_wave5"     "Date_wave6"     "dementia_wave1" "dementia_wave2"
##  [9] "dementia_wave3" "dementia_wave4" "dementia_wave5" "dementia_wave6"
## [13] "education"      "Lopnr"          "sex"
```

Now, assume for some reason, e.g. merge it with other data set, we want to transform it in a long format. There are two variables should be formated: 'Date' and 'dementia'. For beginners, I would recommend to start small. 

* Select the interested columns


```r
fake_snack_df %&gt;%
  select(contains("Date"))
```

```
## # A tibble: 3,365 x 6
##    Date_wave1 Date_wave2 Date_wave3 Date_wave4 Date_wave5 Date_wave6
##    &lt;date&gt;     &lt;date&gt;     &lt;date&gt;     &lt;date&gt;     &lt;date&gt;     &lt;date&gt;    
##  1 1848-01-16 1703-06-26 1807-08-10 1764-12-13 1774-04-04 1739-04-12
##  2 1788-07-16 1785-09-24 1811-08-26 1812-05-24 1777-11-08 1825-04-20
##  3 1833-09-17 1792-10-19 1781-01-06 1746-09-20 1804-04-12 1764-11-26
##  4 1803-04-08 1829-04-27 1744-02-04 1846-08-24 1766-03-26 1735-06-10
##  5 1705-06-10 1734-12-24 1746-03-13 1829-11-30 1711-02-15 1710-06-12
##  6 1733-11-07 1794-06-13 1738-06-02 1846-12-28 1750-10-02 1714-08-09
##  7 1792-08-31 1727-07-07 1848-10-20 1807-12-03 1819-11-05 1708-06-04
##  8 1768-04-16 1704-10-02 1773-10-25 1804-09-12 1722-06-18 1778-08-29
##  9 1810-02-09 1848-05-22 1812-01-08 1730-03-15 1719-02-22 1790-11-14
## 10 1722-08-02 1786-01-17 1845-01-13 1762-03-06 1778-01-19 1785-12-05
## # ... with 3,355 more rows
```

* Read documentation, try to fill in the arguments. The 3 basic arguments are:
  * `cols` tells R what variables to pivot.
  * `names_to` defines a new name for columns in `cols`. 
  * `values_to` gives a new name for values under the columns in `cols`.
  
Let's give a first try:

  

```r
# check pivot_longer() documentation in R: ?pivot_longer()
fake_snack_df %&gt;%
  select(Lopnr, contains("Date")) %&gt;%
  pivot_longer(
    cols = contains("Date"),
    names_to = "wave", names_prefix = "Date",
    values_to = "date"
  )
```

```
## # A tibble: 20,190 x 3
##    Lopnr wave   date      
##    &lt;int&gt; &lt;chr&gt;  &lt;date&gt;    
##  1  1284 _wave1 1848-01-16
##  2  1284 _wave2 1703-06-26
##  3  1284 _wave3 1807-08-10
##  4  1284 _wave4 1764-12-13
##  5  1284 _wave5 1774-04-04
##  6  1284 _wave6 1739-04-12
##  7  2013 _wave1 1788-07-16
##  8  2013 _wave2 1785-09-24
##  9  2013 _wave3 1811-08-26
## 10  2013 _wave4 1812-05-24
## # ... with 20,180 more rows
```

The result above looks good, but 'wave' looks a bit strange. I will leave the task to audience to fix this column.


* Do the same with 'dementia' columns


```r
fake_snack_df %&gt;%
  select(Lopnr, contains("dementia")) %&gt;%
  pivot_longer(
    cols = contains("dementia"),
    names_to = "wave", names_prefix = "dementia",
    values_to = "dementia"
  )
```

```
## # A tibble: 20,190 x 3
##    Lopnr wave   dementia
##    &lt;int&gt; &lt;chr&gt;     &lt;dbl&gt;
##  1  1284 _wave1   -0.246
##  2  1284 _wave2   -0.704
##  3  1284 _wave3   -0.508
##  4  1284 _wave4   -1.48 
##  5  1284 _wave5   -0.402
##  6  1284 _wave6    1.37 
##  7  2013 _wave1    0.377
##  8  2013 _wave2    0.832
##  9  2013 _wave3   -0.824
## 10  2013 _wave4    2.37 
## # ... with 20,180 more rows
```




## Task 
1. Change the arguments in the pivot_longer function to get proper wave column. Result example:

```
## # A tibble: 20,190 x 3
##    Lopnr wave  date      
##    &lt;int&gt; &lt;chr&gt; &lt;date&gt;    
##  1  1284 1     1848-01-16
##  2  1284 2     1703-06-26
##  3  1284 3     1807-08-10
##  4  1284 4     1764-12-13
##  5  1284 5     1774-04-04
##  6  1284 6     1739-04-12
##  7  2013 1     1788-07-16
##  8  2013 2     1785-09-24
##  9  2013 3     1811-08-26
## 10  2013 4     1812-05-24
## # ... with 20,180 more rows
```
2. Merge the two long pivot dataset together.
3. Optional: Pivot the original 'fake_snack_df' by using only one `pivot_longer` function. Put wave and date after 'Lopnr' column. *Hint: check the `names_to` argument and `relocate()` function*. Result example:


```
## # A tibble: 20,190 x 6
##    Lopnr wave  Date          sex education dementia
##    &lt;int&gt; &lt;chr&gt; &lt;date&gt;      &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
##  1  1284 wave1 1848-01-16 -1.62     -1.00    -0.246
##  2  1284 wave2 1703-06-26 -1.62     -1.00    -0.704
##  3  1284 wave3 1807-08-10 -1.62     -1.00    -0.508
##  4  1284 wave4 1764-12-13 -1.62     -1.00    -1.48 
##  5  1284 wave5 1774-04-04 -1.62     -1.00    -0.402
##  6  1284 wave6 1739-04-12 -1.62     -1.00     1.37 
##  7  2013 wave1 1788-07-16  0.384     0.883    0.377
##  8  2013 wave2 1785-09-24  0.384     0.883    0.832
##  9  2013 wave3 1811-08-26  0.384     0.883   -0.824
## 10  2013 wave4 1812-05-24  0.384     0.883    2.37 
## # ... with 20,180 more rows
```





---
class: center, middle

# R markdown

## Basics and daily work uses

---



---






    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightLines": true,
"contIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
// add `data-at-shortcutkeys` attribute to <body> to resolve conflicts with JAWS
// screen reader (see PR #262)
(function(d) {
  let res = {};
  d.querySelectorAll('.remark-help-content table tr').forEach(tr => {
    const t = tr.querySelector('td:nth-child(2)').innerText;
    tr.querySelectorAll('td:first-child .key').forEach(key => {
      const k = key.innerText;
      if (/^[a-z]$/.test(k)) res[k] = t;  // must be a single letter (key)
    });
  });
  d.body.setAttribute('data-at-shortcutkeys', JSON.stringify(res));
})(document);
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
